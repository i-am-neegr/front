<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sudoku Multiplayer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8f9fa; margin: 0; padding: 16px; text-align: center; color: #333; }
        h1 { margin: 12px 0 20px; font-size: 1.8rem; }
        .controls { margin-bottom: 20px; }
        select, button { padding: 10px 18px; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; margin: 6px; cursor: pointer; }
        button { background: #007bff; color: white; border: none; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        #create { background: #007bff; }
        #share { background: #28a745; }
        #tg-launch { background: #0088cc; display: none; } /* кнопка "В Telegram", показывается только если НЕ в TG */
        #board { display: grid; grid-template-columns: repeat(9, 42px); gap: 2px; margin: 0 auto 24px; max-width: 390px; background: #000; padding: 4px; border-radius: 8px; }
        .cell { width: 42px; height: 42px; font-size: 1.4rem; text-align: center; border: none; background: white; box-sizing: border-box; }
        .cell.filled { background: #e9ecef; color: #495057; font-weight: bold; }
        .cell:focus { outline: 2px solid #007bff; }
        .cell[data-row="2"], .cell[data-row="5"] { border-bottom: 3px solid #000 !important; }
        .cell[data-col="2"], .cell[data-col="5"] { border-right: 3px solid #000 !important; }
        #status { font-size: 1.1rem; margin: 16px 0; min-height: 1.4em; }
        #pass { display: none; }
    </style>

    <!-- Telegram WebApp скрипт — загружается всегда, но используем только если есть window.Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1>Sudoku Multiplayer</h1>

<div class="controls">
    <select id="difficulty">
        <option value="easy">Лёгкий</option>
        <option value="medium" selected>Средний</option>
        <option value="hard">Сложный</option>
    </select>
    <button id="create">Создать игру</button>
    <button id="share" style="display:none;">Поделиться</button>
    <button id="tg-launch">Открыть в Telegram</button>
</div>

<div id="status">Ожидание…</div>

<div id="board"></div>

<button id="pass">Пропустить ход</button>

<script>
    // Определяем, запущено ли внутри Telegram
    const isTelegram = !!window.Telegram?.WebApp;
    let tg = isTelegram ? window.Telegram.WebApp : null;

    if (isTelegram) {
        tg.ready();
        tg.expand();
    }

    // userId: приоритет Telegram → guest
    let userId;
    if (isTelegram && tg.initDataUnsafe?.user?.id) {
        userId = String(tg.initDataUnsafe.user.id);
    } else {
        // В обычном вебе — берём из localStorage или генерируем
        userId = localStorage.getItem('sudokuUserId');
        if (!userId) {
            userId = 'guest-' + Math.random().toString(36).slice(2, 10);
            localStorage.setItem('sudokuUserId', userId);
        }
    }

    const backend = 'https://sudoku-2ofn.onrender.com';
    let stompClient = null;
    let sessionId = null;
    let players = [];
    let currentTurn = 0;

    // Читаем sessionId из пути (/abc123) или query (на всякий)
    const path = window.location.pathname.substring(1);
    const params = new URLSearchParams(window.location.search);
    sessionId = params.get('startapp') || (path && path !== '' && path !== 'index.html' ? path.split('/')[0] : null);

    console.log("Режим:", isTelegram ? "Telegram Mini App" : "Обычный браузер");
    console.log("userId:", userId);
    console.log("sessionId:", sessionId);

    if (sessionId) {
        document.getElementById('create').style.display = 'none';
        document.getElementById('share').style.display = 'inline-block';
        document.getElementById('status').textContent = `Подключаемся к игре ${sessionId}...`;
        connectWebSocket();
    } else if (!isTelegram) {
        // Показываем кнопку "Открыть в Telegram" только в обычном браузере
        document.getElementById('tg-launch').style.display = 'inline-block';
    }

    function connectWebSocket() {
        if (!sessionId) return;

        const socket = new SockJS(`${backend}`);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            console.log('WebSocket подключён');

            stompClient.subscribe(`/topic/${sessionId}/board`, msg => {
                const data = JSON.parse(msg.body);
                renderBoard(data.board);
                currentTurn = data.currentTurn;
                updateStatus();
            });

            stompClient.subscribe(`/topic/${sessionId}/players`, msg => {
                const data = JSON.parse(msg.body);
                players = data.players || [];
                updateStatus();
            });

            stompClient.subscribe(`/topic/${sessionId}/finish`, msg => {
                const data = JSON.parse(msg.body);
                document.getElementById('status').textContent = data.message || 'Игра завершена!';
                document.getElementById('pass').style.display = 'none';
            });

            stompClient.send('/app/join', {}, JSON.stringify({ sessionId, userId }));
        }, error => {
            console.error('WebSocket ошибка:', error);
            setTimeout(connectWebSocket, 3000);
        });
    }

    // Создать игру
    document.getElementById('create').onclick = () => {
        const difficulty = document.getElementById('difficulty').value;

        fetch(`${backend}/api/sudoku/create?difficulty=${difficulty}&userId=${userId}`, {
            method: 'POST',
            headers: { 'Accept': 'application/json' }
        })
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            })
            .then(data => {
                sessionId = data.sessionId;
                renderBoard(data.board);
                document.getElementById('share').style.display = 'inline-block';
                document.getElementById('pass').style.display = 'inline-block';
                updateStatus();
                connectWebSocket();

                // Меняем URL для удобного шаринга
                history.replaceState(null, '', `/${sessionId}`);
            })
            .catch(err => {
                console.error(err);
                alert('Не удалось создать игру\n' + err.message);
            });
    };

    // Поделиться (только прямая ссылка)
    document.getElementById('share').onclick = async () => {
        if (!sessionId) return alert("Сначала создайте игру");

        const shareLink = `${window.location.origin}/${sessionId}`;

        try {
            await navigator.clipboard.writeText(shareLink);
            const btn = document.getElementById('share');
            btn.textContent = "Скопировано ✓";
            setTimeout(() => btn.textContent = "Поделиться", 2000);
        } catch (err) {
            alert(`Скопируй вручную:\n${shareLink}`);
        }
    };

    // Кнопка "Открыть в Telegram" (если запущено не в TG)
    document.getElementById('tg-launch').onclick = () => {
        const botUsername = 'sudoku52bot';
        const tgLink = `https://t.me/${botUsername}/app?startapp=${sessionId || ''}`;
        window.open(tgLink, '_blank');
    };

    // Пропустить ход
    document.getElementById('pass').onclick = () => {
        if (isMyTurn() && stompClient) {
            stompClient.send('/app/pass', {}, JSON.stringify({ sessionId, userId }));
        }
    };

    function renderBoard(board) { /* ... тот же код, что был раньше ... */ }

    function updateStatus() { /* ... тот же код ... */ }

    function isMyTurn() {
        return players.indexOf(userId) === currentTurn;
    }

    updateStatus();
</script>
</body>
</html>