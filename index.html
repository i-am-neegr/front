<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sudoku Multiplayer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #f8f9fa;
            --cell-bg: #ffffff;
            --filled-bg: #e9ecef;
            --border: #dee2e6;
            --thick-border: #495057;
            --accent: #0d6efd;
            --success: #198754;
            --error: #dc3545;
            --text: #212529;
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            margin: 0 0 16px;
            font-size: 1.6rem;
            color: var(--text);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        select, button {
            padding: 10px 16px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            transition: all 0.15s;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
        }

        button:hover:not(:disabled) {
            background: #0b5ed7;
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #status {
            font-size: 1.1rem;
            margin: 12px 0;
            text-align: center;
            min-height: 1.4em;
        }

        #players {
            font-size: 0.95rem;
            color: #6c757d;
            margin-bottom: 12px;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 2px;
            max-width: 100%;
            width: 360px;
            background: var(--thick-border);
            padding: 2px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .cell {
            aspect-ratio: 1;
            background: var(--cell-bg);
            border: 1px solid var(--border);
            font-size: 1.4rem;
            text-align: center;
            font-weight: bold;
            color: var(--accent);
            transition: background 0.2s;
        }

        .cell.filled {
            background: var(--filled-bg);
            color: #495057;
            pointer-events: none;
        }

        .cell.error {
            background: #ffebee;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        /* Толстые линии для 3×3 блоков */
        .cell[data-row="0"], .cell[data-row="3"], .cell[data-row="6"] { border-top: 3px solid var(--thick-border); }
        .cell[data-col="0"], .cell[data-col="3"], .cell[data-col="6"] { border-left: 3px solid var(--thick-border); }
        .cell[data-row="8"] { border-bottom: 3px solid var(--thick-border); }
        .cell[data-col="8"] { border-right: 3px solid var(--thick-border); }

        @media (max-width: 400px) {
            #board { width: 100%; max-width: none; gap: 1px; }
            .cell { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

<h2>Sudoku</h2>

<div class="controls">
    <select id="difficulty">
        <option value="easy">Лёгкий</option>
        <option value="medium" selected>Средний</option>
        <option value="hard">Сложный</option>
    </select>
    <button id="createBtn">Новая игра</button>
    <button id="shareBtn" style="display:none;">Поделиться</button>
</div>

<div id="status">Загрузка...</div>
<div id="players"></div>

<div id="board"></div>

<button id="passBtn" style="display:none; margin-top:16px;">Пропустить ход</button>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const backend = 'https://sudoku-2ofn.onrender.com'; // ← замени
    const botUsername = 'sudoku52bot'; // ← замени на username бота без @

    const user = tg.initDataUnsafe.user || {};
    const userId = user.id?.toString() || ('guest_' + Date.now());
    const userName = user.username || user.first_name || 'Игрок';
    const initData = tg.initData;

    let sessionId = null;
    let polling = null;

    // Получаем sessionId из startapp, если есть
    const params = new URLSearchParams(location.search);
    if (params.has('startapp')) {
        sessionId = params.get('startapp');
        joinGame();
    }

    // ─── События ────────────────────────────────────────

    document.getElementById('createBtn').onclick = async () => {
        const diff = document.getElementById('difficulty').value;
        try {
            const res = await fetchWithAuth(`${backend}/create?difficulty=${diff}`);
            const data = await res.json();
            sessionId = data.sessionId;
            updateUI(data);
            startPolling();
            showShareAndPass();
        } catch (err) {
            tg.showPopup({title: "Ошибка", message: err.message || "Не удалось создать игру"});
        }
    };

    document.getElementById('shareBtn').onclick = () => {
        const link = `https://t.me/${botUsername}/app?startapp=${sessionId}`;
        navigator.clipboard.writeText(link).then(() => {
            tg.showPopup({message: "Ссылка скопирована в буфер обмена"});
        }).catch(() => {
            tg.showPopup({message: "Ссылка:\n" + link});
        });
    };

    document.getElementById('passBtn').onclick = async () => {
        if (!isMyTurn()) return tg.showPopup({message: "Не ваш ход"});
        try {
            const res = await fetchWithAuth(`${backend}/${sessionId}/pass`);
            const data = await res.json();
            if (data.success) updateStatus();
        } catch (err) {
            tg.showPopup({message: "Не удалось пропустить ход"});
        }
    };

    // ─── Функции ────────────────────────────────────────

    async function joinGame() {
        try {
            const res = await fetchWithAuth(`${backend}/join/${sessionId}`);
            const data = await res.json();
            updateUI(data);
            startPolling();
            showShareAndPass();
        } catch (err) {
            tg.showPopup({title: "Ошибка", message: "Игра не найдена или недоступна"});
        }
    }

    function startPolling() {
        if (polling) clearInterval(polling);
        polling = setInterval(async () => {
            try {
                const res = await fetchWithAuth(`${backend}/${sessionId}`);
                const data = await res.json();
                updateUI(data);
                if (data.finished) {
                    clearInterval(polling);
                    tg.showAlert("Игра завершена! Судоку решено.");
                }
            } catch {}
        }, 2500);
    }

    function updateUI(data) {
        renderBoard(data.board);
        renderPlayers(data.players);
        updateStatus(data.currentTurnIndex, data.players);
        if (data.finished) document.getElementById('status').textContent = "✅ Судоку решено!";
    }

    function renderBoard(board) {
        const container = document.getElementById('board');
        container.innerHTML = '';
        board.forEach((row, r) => {
            row.forEach((val, c) => {
                const input = document.createElement('input');
                input.type = 'tel'; // лучше для мобильных
                input.inputMode = 'numeric';
                input.pattern = '[1-9]';
                input.className = 'cell';
                input.value = val || '';
                input.dataset.row = r;
                input.dataset.col = c;

                if (val) {
                    input.classList.add('filled');
                    input.disabled = true;
                } else {
                    input.oninput = handleCellInput;
                }

                container.appendChild(input);
            });
        });
    }

    async function handleCellInput(e) {
        const val = e.target.value.trim();
        if (!/[1-9]/.test(val)) {
            e.target.value = '';
            return;
        }
        if (!isMyTurn()) {
            e.target.value = '';
            tg.showPopup({message: "Не ваш ход"});
            return;
        }

        const r = +e.target.dataset.row;
        const c = +e.target.dataset.col;
        const num = +val;

        try {
            const res = await fetchWithAuth(`${backend}/${sessionId}/move?row=${r}&col=${c}&value=${num}`);
            const data = await res.json();
            if (data.success) {
                renderBoard(data.board);
                updateStatus(data.currentTurnIndex, data.players);
                if (data.finished) {
                    tg.showAlert("Поздравляем! Судоку решено!");
                }
            } else {
                e.target.classList.add('error');
                setTimeout(() => e.target.classList.remove('error'), 600);
                e.target.value = '';
            }
        } catch {
            e.target.value = '';
        }
    }

    function renderPlayers(players = []) {
        document.getElementById('players').textContent =
            players.length ? `Игроки: ${players.map(p => p.name).join(', ')}` : '';
    }

    function updateStatus(turnIndex, players = []) {
        const myIndex = players.findIndex(p => p.id === userId);
        const isSingle = players.length <= 1;
        const isMy = isSingle || myIndex === turnIndex;

        let text = isSingle ? "Одиночная игра — ваш ход" : `Ход: ${players[turnIndex]?.name || '?'}`;
        if (!isMy) text += " (ожидание)";
        document.getElementById('status').textContent = text;
    }

    function isMyTurn() {
        // Логика уже внутри updateStatus, но для кнопки pass
        return true; // в одиночном режиме всегда true, в мульти — проверяется на бэкенде
    }

    function showShareAndPass() {
        document.getElementById('shareBtn').style.display = 'inline-block';
        // Pass показываем только если мультиплеер (но бэкенд сам отклонит в одиночном)
        document.getElementById('passBtn').style.display = 'inline-block';
    }

    async function fetchWithAuth(url) {
        const fullUrl = url + (url.includes('?') ? '&' : '?') +
            `userId=${userId}&name=${encodeURIComponent(userName)}&initData=${encodeURIComponent(initData)}`;
        const res = await fetch(fullUrl, { method: url.includes('/move') || url.includes('/pass') ? 'POST' : 'GET' });
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || `HTTP ${res.status}`);
        }
        return res;
    }
</script>
</body>
</html>