<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sudoku Multiplayer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 16px;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
            color: #212529;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            margin: 8px 0 16px;
            font-size: 1.6rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        select, button {
            padding: 10px 18px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
        }

        button {
            background: #0d6efd;
            color: white;
            border: none;
        }

        button:hover:not(:disabled) {
            background: #0a58ca;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #status {
            font-size: 1.1rem;
            margin: 12px 0;
            text-align: center;
            min-height: 1.5em;
        }

        #players {
            font-size: 0.95rem;
            color: #6c757d;
            margin: 8px 0 16px;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 2px;
            width: 360px;
            max-width: 100%;
            background: #495057;
            padding: 2px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .cell {
            aspect-ratio: 1;
            background: white;
            border: 1px solid #dee2e6;
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            color: #0d6efd;
        }

        .cell.filled {
            background: #e9ecef;
            color: #495057;
            pointer-events: none;
        }

        .cell.error {
            background: #ffebee;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        /* 3×3 блоки */
        .cell[data-row="0"], .cell[data-row="3"], .cell[data-row="6"] { border-top: 3px solid #495057; }
        .cell[data-col="0"], .cell[data-col="3"], .cell[data-col="6"] { border-left: 3px solid #495057; }
        .cell[data-row="8"] { border-bottom: 3px solid #495057; }
        .cell[data-col="8"] { border-right: 3px solid #495057; }

        @media (max-width: 400px) {
            #board { width: 100%; gap: 1px; }
            .cell { font-size: 1.15rem; }
        }
    </style>
</head>
<body>

<h2>Sudoku</h2>

<div class="controls">
    <select id="difficulty">
        <option value="easy">Лёгкий</option>
        <option value="medium" selected>Средний</option>
        <option value="hard">Сложный</option>
    </select>
    <button id="create">Создать игру</button>
    <button id="share" style="display:none;">Поделиться</button>
</div>

<div id="status">Ожидание...</div>
<div id="players"></div>

<div id="board"></div>

<button id="pass" style="display:none; margin-top: 20px;">Пропустить ход</button>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const WS_URL = 'https://sudoku-2ofn.onrender.com';           // ← замени на свой
    const REST_URL = 'https://sudoku-2ofn.onrender.com/api/sudoku'; // ← замени на свой
    const BOT_USERNAME = 'sudoku52bot';                        // ← имя бота без @

    const user = tg.initDataUnsafe.user || {};
    const userId = user.id?.toString() || ('guest_' + Date.now());
    const userName = user.username || user.first_name || 'Игрок';

    let sessionId = null;
    let stompClient = null;
    let polling = null;

    // Автоприсоединение по startapp
    const params = new URLSearchParams(location.search);
    if (params.has('startapp')) {
        sessionId = params.get('startapp');
        connectWS(() => join());
    }

    // ─── WebSocket ───────────────────────────────────────

    function connectWS(callback) {
        if (stompClient?.connected) {
            if (callback) callback();
            return;
        }

        const socket = new SockJS(WS_URL);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, frame => {
            console.log('WebSocket connected');

            // Приватный канал для создателя / присоединившегося
            stompClient.subscribe('/user/topic/session', msg => {
                const data = JSON.parse(msg.body);
                sessionId = data.sessionId;
                updateUI(data);
                showButtons();
                startPolling();
            });

            // Общие обновления
            if (sessionId) {
                stompClient.subscribe('/topic/' + sessionId + '/players', msg => {
                    const { players } = JSON.parse(msg.body);
                    renderPlayers(players);
                    updateStatus();
                });

                stompClient.subscribe('/topic/' + sessionId + '/board', msg => {
                    const { board, currentTurnIndex } = JSON.parse(msg.body);
                    renderBoard(board);
                    updateStatusFromIndex(currentTurnIndex);
                });

                stompClient.subscribe('/topic/' + sessionId + '/turn', msg => {
                    const { currentTurnIndex } = JSON.parse(msg.body);
                    updateStatusFromIndex(currentTurnIndex);
                });

                stompClient.subscribe('/topic/' + sessionId + '/finish', () => {
                    document.getElementById('status').textContent = 'Игра завершена! Судоку решено!';
                    tg.showAlert('Судоку решено!');
                });
            }

            if (callback) callback();
        }, err => {
            console.error('WS error:', err);
            tg.showPopup({ message: 'Ошибка соединения с сервером' });
        });
    }

    // ─── Действия ───────────────────────────────────────

    document.getElementById('create').onclick = () => {
        const diff = document.getElementById('difficulty').value;
        connectWS(() => {
            stompClient.send('/app/create', {}, JSON.stringify({
                difficulty: diff,
                userId,
                name: userName
            }));
        });
    };

    function join() {
        connectWS(() => {
            stompClient.send('/app/join', {}, JSON.stringify({
                sessionId,
                userId,
                name: userName
            }));
        });
    }

    document.getElementById('share').onclick = () => {
        const link = `https://t.me/${BOT_USERNAME}/app?startapp=${sessionId}`;
        navigator.clipboard.writeText(link).then(() => {
            tg.showPopup({ message: 'Ссылка скопирована в буфер' });
        }).catch(() => {
            tg.showPopup({ message: link });
        });
    };

    document.getElementById('pass').onclick = () => {
        if (stompClient?.connected) {
            stompClient.send('/app/pass', {}, JSON.stringify({ sessionId, userId }));
        }
    };

    // ─── Polling (запасной канал) ───────────────────────

    function startPolling() {
        if (polling) clearInterval(polling);
        polling = setInterval(() => {
            if (!sessionId) return;
            fetch(`${REST_URL}/${sessionId}`)
                .then(r => r.ok ? r.json() : null)
                .then(data => {
                    if (data) {
                        renderBoard(data.board);
                        renderPlayers(data.players);
                        updateStatusFromIndex(data.currentTurnIndex);
                        if (data.finished) {
                            clearInterval(polling);
                            tg.showAlert('Игра завершена!');
                        }
                    }
                })
                .catch(() => {});
        }, 4000);
    }

    // ─── UI ─────────────────────────────────────────────

    function updateUI(data) {
        sessionId = data.sessionId;
        renderBoard(data.board);
        renderPlayers(data.players);
        updateStatusFromIndex(data.currentTurnIndex);
    }

    function renderBoard(board) {
        const el = document.getElementById('board');
        el.innerHTML = '';
        board.forEach((row, r) => {
            row.forEach((val, c) => {
                const input = document.createElement('input');
                input.type = 'tel';
                input.className = 'cell';
                input.value = val || '';
                input.dataset.row = r;
                input.dataset.col = c;

                if (val) {
                    input.classList.add('filled');
                    input.disabled = true;
                } else {
                    input.oninput = e => {
                        const v = e.target.value.trim();
                        if (!/[1-9]/.test(v)) {
                            e.target.value = '';
                            return;
                        }
                        const num = +v;
                        if (stompClient?.connected) {
                            stompClient.send('/app/move', {}, JSON.stringify({
                                sessionId,
                                userId,
                                row: r,
                                col: c,
                                value: num
                            }));
                            e.target.value = ''; // очистим сразу
                        }
                    };
                }

                el.appendChild(input);
            });
        });
    }

    function renderPlayers(players = []) {
        document.getElementById('players').textContent =
            players.length ? `Игроки: ${players.map(p => p.name).join(', ')}` : '';
    }

    function updateStatusFromIndex(idx) {
        document.getElementById('status').textContent = `Ход игрока ${idx + 1}`;
    }

    function showButtons() {
        document.getElementById('share').style.display = 'inline-block';
        document.getElementById('pass').style.display = 'inline-block';
    }
</script>
</body>
</html>