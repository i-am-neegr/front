<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sudoku Multiplayer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 16px;
            text-align: center;
            color: #333;
        }
        h1 {
            margin: 12px 0 20px;
            font-size: 1.8rem;
        }
        .controls {
            margin-bottom: 20px;
        }
        select, button {
            padding: 10px 18px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin: 6px;
            cursor: pointer;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
        }
        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(9, 42px);
            gap: 2px;
            margin: 0 auto 24px;
            max-width: 390px;
            background: #000;
            padding: 4px;
            border-radius: 8px;
        }
        .cell {
            width: 42px;
            height: 42px;
            font-size: 1.4rem;
            text-align: center;
            border: none;
            background: white;
            box-sizing: border-box;
        }
        .cell.filled {
            background: #e9ecef;
            color: #495057;
            font-weight: bold;
        }
        .cell:focus {
            outline: 2px solid #007bff;
        }
        /* жирные линии 3×3 */
        .cell[data-row="2"], .cell[data-row="5"] { border-bottom: 3px solid #000 !important; }
        .cell[data-col="2"], .cell[data-col="5"] { border-right: 3px solid #000 !important; }

        #status {
            font-size: 1.1rem;
            margin: 16px 0;
            min-height: 1.4em;
        }
        #share, #pass {
            display: none;
        }
    </style>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1>Sudoku Multiplayer</h1>

<div class="controls">
    <select id="difficulty">
        <option value="easy">Лёгкий</option>
        <option value="medium" selected>Средний</option>
        <option value="hard">Сложный</option>
    </select>
    <button id="create">Создать игру</button>
    <button id="share">Поделиться</button>
</div>

<div id="status">Ожидание…</div>

<div id="board"></div>

<button id="pass">Пропустить ход</button>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const user = tg.initDataUnsafe.user || {};
    const userId = user.id ? String(user.id) : 'guest-' + Date.now();

    const backend = 'https://sudoku-2ofn.onrender.com';
    const botUsername = 'sudoku52bot';

    let stompClient = null;
    let sessionId = null;
    let players = [];
    let currentTurn = 0;

    // Автоприсоединение по параметру startapp
    const params = new URLSearchParams(window.location.search);
    if (params.has('startapp')) {
        sessionId = params.get('startapp');
        connectWebSocket();
    }

    function connectWebSocket() {
        const socket = new SockJS(`${backend}/ws`);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            console.log('WebSocket подключён');

            stompClient.subscribe(`/topic/${sessionId}/board`, msg => {
                const data = JSON.parse(msg.body);
                renderBoard(data.board);
                currentTurn = data.currentTurn;
                updateStatus();
            });

            stompClient.subscribe(`/topic/${sessionId}/players`, msg => {
                const data = JSON.parse(msg.body);
                players = data.players || [];
                updateStatus();
            });

            stompClient.subscribe(`/topic/${sessionId}/finish`, msg => {
                const data = JSON.parse(msg.body);
                document.getElementById('status').textContent = data.message || 'Игра завершена!';
                document.getElementById('pass').style.display = 'none';
            });

            // присоединяемся
            stompClient.send('/app/join', {}, JSON.stringify({ sessionId, userId }));
        }, function (error) {
            console.error('WebSocket ошибка:', error);
            setTimeout(connectWebSocket, 3000);
        });
    }

    // Создать игру
    document.getElementById('create').onclick = () => {
        const difficulty = document.getElementById('difficulty').value;

        fetch(`${backend}/api/sudoku/create?difficulty=${difficulty}&userId=${userId}`, {
            method: 'POST',
            headers: { 'Accept': 'application/json' }
        })
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            })
            .then(data => {
                sessionId = data.sessionId;
                renderBoard(data.board);
                document.getElementById('share').style.display = 'inline-block';
                document.getElementById('pass').style.display = 'inline-block';
                updateStatus();
                connectWebSocket();
            })
            .catch(err => {
                console.error(err);
                alert('Не удалось создать игру\n' + err.message);
            });
    };

    // Поделиться
    document.getElementById('share').onclick = () => {
        const link = `https://t.me/${botUsername}/app?startapp=${sessionId}`;
        tg.openTelegramLink(link);
    };

    // Пропустить ход
    document.getElementById('pass').onclick = () => {
        if (isMyTurn()) {
            stompClient.send('/app/pass', {}, JSON.stringify({ sessionId, userId }));
        }
    };

    function renderBoard(board) {
        const container = document.getElementById('board');
        container.innerHTML = '';

        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                const input = document.createElement('input');
                input.type = 'tel'; // лучше для мобильных
                input.className = 'cell';
                input.dataset.row = r;
                input.dataset.col = c;
                input.value = board[r][c] || '';

                if (board[r][c] !== 0) {
                    input.classList.add('filled');
                    input.readOnly = true;
                } else {
                    input.maxLength = 1;
                    input.addEventListener('input', e => {
                        const v = e.target.value;
                        if (v && isMyTurn()) {
                            const num = parseInt(v, 10);
                            if (num >= 1 && num <= 9) {
                                stompClient.send('/app/move', {}, JSON.stringify({
                                    sessionId,
                                    userId,
                                    row: r,
                                    col: c,
                                    value: num
                                }));
                            }
                            e.target.value = ''; // очищаем после отправки
                        }
                    });
                }

                container.appendChild(input);
            }
        }
    }

    function updateStatus() {
        const idx = players.indexOf(userId);
        const isMy = idx >= 0 && idx === currentTurn;
        const text = players.length === 0
            ? 'Ожидание игроков…'
            : `Игроков: ${players.length} • Ход ${isMy ? 'ваш' : 'другого'}`;
        document.getElementById('status').textContent = text;
        document.getElementById('pass').disabled = !isMy;
    }

    function isMyTurn() {
        return players.indexOf(userId) === currentTurn;
    }

    // начальный статус
    updateStatus();
</script>
</body>
</html>